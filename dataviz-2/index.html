<!DOCTYPE html>
	<head>
        <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, shrink-to-fit=0, minimum-scale=1.0, maximum-scale=1.0">
	    <title>ORCA - Valuable Contributions</title>
	    <meta name="author" content="Nadieh Bremer">
	    <meta name="description" content="A visualization of all the commits of a GitHub repository with the noteworthy commits highlighted">
        <link rel="shortcut icon" href="#">

        <!-- Styling -->
        <link rel="stylesheet" href="css/style.css">
		
        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

        <!-- JavaScript libraries -->
        <script src="lib/d3.v7.js"></script>
        <script src="lib/seedRandom.min.js"></script>

        <!-- Custom JavaScript file -->
        <script src="createORCAVisual.js"></script>

	</head>
	<body>
        <div id="chart-wrapper">
            <div id="chart-introduction">

                <!-- The stuff above the chart -->
                <div id="chart-introduction-content">
                    <div id="chart-title">
                        <h1>All <span class="commit-num"></span>commits of</h1>
                        <h1><span id="title-repo-name" class="repository">mozilla/pdf.js</span></h1>
                        <p id="last-commit-date"></p>
                    </div>
                    <div id="chart-intro-text">
                        <p>The <span class="repo-name repository">mozilla/pdf.js</span> repository has seen many improvements from its various contributors since the first commit<span id="first-commit-date"></span>. <strong>The visualization below shows all <span class="commit-num"></span>commits that have been made since then.</strong></p>
                        
                        <p>Each commit is represented as a small circle. They're grouped together by (commit) month, giving an overview of which periods had relatively few updates while other time periods saw a lot of activity.</p>

                    </div>
                </div>

                <!-- The legends -->
                <div id="chart-explanation">
                    <p class="header"><strong>HOW TO READ THIS VISUAL</strong></p>

                    <!-- Add the legend.svg in the img folder -->
                    <div id="legend-image">
                        <img class="legend" src="img/legend_insertions.png" alt="Circles with a turquoise outer ring have more line insertions than deletions">
                        <img class="legend" src="img/legend_deletions.png" alt="Circles with a pink outer ring have more line deletions than insertions">
                        <img class="legend" src="img/legend_similar.png" alt="Dark blue circles have about the same number of insertions and deletions">
                        <img class="legend" src="img/legend_no_change.png" alt="A small yellow circle represent a commit where no files were changed">
                        <img class="legend" src="img/legend_version.png" alt="A colored ring around a commit shows a version release">
                    </div>

                    <p id="legend-note"><span class="insertions">◑</span> size doesn't scale <i>completely</i> linearly with number of lines <span class="deletions">◐</span></p>
                </div>
            </div>

            <!-- The visual will be drawn here -->
            <div id="chart-container">
                <div id="tooltip">
                    <div class="tooltip-container">
                        <span id="tooltip-close">&times;</span>
                        <p class="tooltip-header">author</p>
                        <p id="tooltip-author-name">Name</p>
                        <p class="tooltip-header">committed on</p>
                        <p id="tooltip-commit-time">February 7, 2024</p>
                        <p id="tooltip-commit-title"></p>
                        <p id="tooltip-commit-release-header" class="tooltip-header">release</p>
                        <p id="tooltip-commit-release">v4.7.09</p>
                        <p class="tooltip-header">changes made</p>
                        <p id="tooltip-files-changed" class="tooltip-changes"><span id="tooltip-num-files">3 files</span> changed</p>
                        <p id="tooltip-commit-changes" class="tooltip-changes"><span id="tooltip-num-insertions">468 insertions</span> <span class="insertions">(+)</span> / <span id="tooltip-num-deletions">263 deletions</span> <span class="deletions">(-)</span></p>
                        <p class="tooltip-header">commit hash</p>
                        <p id="tooltip-commit-hash"></p>
                    </div>
                </div>
            </div>

            <div id="chart-extra">
                <button id="dataviz-download-data">Download the RAW data</button>
                <p id="dataviz-credit">Visualization Designed & Created by Nadieh Bremer | <a href="https://www.visualcinnamon.com/" target="_blank">Visual Cinnamon</a></p>
            </div>
        </div>

        <script>
            let params = new URLSearchParams(window.location.search)
            const REPOSITORY = [
                "pdfjs"
            ].indexOf(params.get("repo")) === -1 ? "pdfjs" : params.get("repo")

            let REPOSITORY_FULL = "mozilla/pdf.js" // Default

            let REPOSITORY_NAME = REPOSITORY_FULL.substring(REPOSITORY_FULL.indexOf("/") + 1)

            /////////////////////////////////////////////////////////
            ///////////////////////// START /////////////////////////
            /////////////////////////////////////////////////////////

            ////////////////// Datasets to Read in //////////////////
            let promises = []
            promises.push(d3.csv(`data/${REPOSITORY}/commits.csv`))

            /////////////////// Fonts to activate ///////////////////
            const FONT_FAMILY = "Atkinson Hyperlegible"
            document.fonts.load(`normal 400 10px "${FONT_FAMILY}"`)
            document.fonts.load(`italic 400 10px "${FONT_FAMILY}"`)
            document.fonts.load(`normal 700 10px "${FONT_FAMILY}"`)
            document.fonts.load(`italic 700 10px "${FONT_FAMILY}"`)

            /////////////////// Figure out sizing ///////////////////
            // Get the div container that will hold the chart
            let container = document.getElementById("chart-container")
            // Get the width of the container
            let width = container.offsetWidth

            ///////////////////// Start Drawing /////////////////////
            // Set-up the visual - Doesn't draw anything yet
            // createORCAVisual(container).then(ORCAVisual => {
            //     ORCAVisual
            //         .width(width)
            //         .repository(REPOSITORY_FULL)
            // })

            // Read in the data and create the visual
            createORCAVisual(container).then(ORCAVisual => {
                // Set-up the visual - Doesn't draw anything yet
                ORCAVisual
                    .width(width)
                    // .repository(REPOSITORY_FULL)

                document.fonts.ready.then(() => {
                    Promise.all(promises).then(values => {
                        let formatDigit = d3.format(",.0f")
                        let parseDate = d3.timeParse("%Y-%m-%d %H:%M:%S %Z")
                        let formatDate = d3.utcFormat("%B %-e, %Y")

                        // Create a deep copy of the data in values
                        let data_raw = []
                        data_raw.push(JSON.parse(JSON.stringify(values[0]))) // commits

                        /////////////////////////////////////////////////
                        // Very specific to this example, but get some statistics on the data and put this in the intro text
                        let num_commits = values[0].length
                        document.querySelectorAll(".commit-num").forEach(d => d.innerHTML = `${formatDigit(num_commits)} `)

                        // Latest commit date
                        let latest_commit_date = formatDate(parseDate(values[0][0].commit_time))
                        document.getElementById("last-commit-date").innerHTML = `Up to ${latest_commit_date}`

                        // First commit date
                        let first_commit_date = formatDate(parseDate(values[0][values[0].length - 1].commit_time))
                        document.getElementById("first-commit-date").innerHTML = ` on ${first_commit_date}`

                        /////////////////////////////////////////////
                        // It expects one dataset of all the commits made to the repository
                        ORCAVisual(values)

                        /////////////////////////////////////////////
                        // Let people download the raw data
                        const download_button = document.getElementById("dataviz-download-data")
                        download_button.addEventListener("click", () => {
                            // Download all datasets
                            downloadData(data_raw[0], `${REPOSITORY}-commits`)

                            function downloadData(data, filename) {
                                // Create a blob of the data
                                let blob = new Blob([d3.csvFormat(data)], {type: "text/csv;charset=utf-8"})
                                // Create a link to download it
                                let link = document.createElement("a")
                                link.href = window.URL.createObjectURL(blob)
                                link.download = `${filename}.csv`
                                // Click the link
                                link.click()
                            }// function downloadData
                        })//on click
                    })//promises
                })//fonts.ready

                /////////////////////////////////////////////////////
                //////////////// Handle page resizing ///////////////
                /////////////////////////////////////////////////////

                let current_width = window.innerWidth
                let resizeTimer = null
                window.addEventListener("resize", function () {
                    // Reset timer - Only resize if something truly appears to happen
                    // So added a little timeout
                    clearTimeout(resizeTimer)

                    resizeTimer = setTimeout(() => {
                        // Only resize if the width is changed
                        if (window.innerWidth !== current_width) {
                            current_width = window.innerWidth

                            // Get the new sizes
                            let width = container.offsetWidth

                            //Update the visual
                            ORCAVisual
                                .width(width)
                                .resize()
                        }// if
                    }, 300)
                })//on resize

            })//createORCAVisual

            /////////////////////////////////////////////////////////
            //////////////////////// Save PNG ///////////////////////
            /////////////////////////////////////////////////////////

            //Save as PNG on "s" and other key functions
            window.onkeydown = function (e) {
                //Save at the current size
                if (e.which === 83) { //"s" key
                    e.preventDefault()
                    savePNG()
                }//if "s"
            }//onkeydown

            async function savePNG() {
                let time = new Date()
                let date_time = `${time.getFullYear()}-${pad(time.getMonth() + 1)}-${pad(time.getDate())} at ${pad(time.getHours())}.${pad(time.getMinutes())}.${pad(time.getSeconds())}`

                let download_link = document.createElement("a")
                // Get the element with id canvas
                document.getElementById("canvas").toBlob(function(blob) {
                    let url = URL.createObjectURL(blob)
                    download_link.href = url
                    download_link.download = `ORCA - ${date_time}.png`
                    download_link.click()
                    console.log("Saved image")
                })//toBlob

                //Pad with zero's on date/time
                function pad(value) {
                    if (value < 10) return '0' + value
                    else return value
                }//function pad
            }//savePNG

        </script>
	</body>
</html>