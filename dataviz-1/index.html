<!DOCTYPE html>
	<head>
        <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, shrink-to-fit=0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	    <title>ORCA</title>
	    <meta name="author" content="Nadieh Bremer">
	    <meta name="description" content="">
        <link rel="shortcut icon" href="#">

        <link rel="stylesheet" href="css/style.css">
		
        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

        <!-- JavaScript files -->
        <script src="lib/d3.v7.js"></script>
        <script src="lib/d3-delaunay.js"></script>
        <script src="lib/d3-bboxCollide.min.js"></script>
        <!-- <script src="lib/spectral.js"></script> -->

        <!-- Custom JavaScript file -->
        <script src="createORCAVisual.js"></script>

	</head>
	<body>
        <div id="chart-wrapper">
            <div id="chart-introduction">
                <div id="chart-title">
                    <h1>The Top Contributor Network of</h1>
                    <h1><span id="title-repo-name" class="central-repo">mozilla/pdf.js</span></h1>
                </div>
                <div id="chart-intro-text">
                    <p>The <span class="repo-name central-repo">mozilla/pdf.js</span> repository has seen many improvements from its <span id="repo-num-contributors"></span><span class="contributor">contributors</span> since it was created<span id="repo-start-date"></span>.</p>

                    <p>The visual below shows all of the contributors to <span class="repo-name-only">pdf.js</span> and focuses on the <span class="top-contributor-num"></span>contributors that have made the most commits and/or are supported through <strong>ORCA</strong> (the <strong>"Open Retrospective Compensation Agreement"</strong>). Revealing how they are involved with<span id="top-repo-num"> other</span> <span class="repository">repositories</span> as well. <span style="font-size: 0.7em; opacity: 0.6; font-style: italic;">(only counting repos with at least 30 stars)</span></p>

                    <div id="bar-chart-wrapper">
                        <p>The <span id="num-commits-top"></span>commits by these <span class="top-contributor-num"></span> contributors, make up <span id="percentage-commits-top"></span> of the total number of commits made to <span class="repo-name-only">pdf.js</span>.</p>
                        <div id="commit-bar-chart">
                            <div id="bar-orca"></div>
                            <div id="bar-non-orca"></div>
                            <div id="bar-remaining"></div>
                        </div>
                        <div id="legend-bar-chart">
                            <ul>
                                <li id="item-orca"><span id="num-orca"></span>Contributors that are supported via ORCA</li>
                                <li id="item-non-orca"><span id="num-non-orca"></span>Top contributors not supported via ORCA</li>
                                <li id="item-remaining"><span id="num-remaining"></span>Remaining contributors</li>
                            </ul>
                        </div>
                    </div>

                    <p>The top contributors are separated into two outer rings. In the inner ring we find those that have been supported via ORCA for their work on <span class="repo-name-only">pdf.js</span>. Whereas in the outer ring we find those that have not (yet).</p>

                    <p>In the <strong>center we focus on the connections <i>amongst</i> contributors</strong>. Where we can find those repositories that multiple contributors have worked on (and the <span class="owner">owners</span>, if there is more than one of their repos present).</p>

                    <p>Explore the ecosystem of open source projects that are touched by the top contributors to <span class="repo-name-only">pdf.js</span>. See how the impact of ORCA <i>could</i> reach far wider than just that one repository.</p>

                    <p><a id="explanation-link" href="#chart-explanation"><strong>A full explanation on how to read the network can be found just below the visual.</strong></a></p>
                </div>
            </div>

            <div id="chart-container">
                <canvas id="canvas"></canvas>
                <canvas id="canvas-click"></canvas>
                <canvas id="canvas-hover"></canvas>
            </div>

            <div id="chart-explanation" class="double-column">
                <p class="header"><strong>HOW TO READ THIS VISUAL</strong></p>

                <p id="tldr-explanation"><strong>TL;DR</strong> | Below you can read the full details on the many ways data has been woven into this visual, but in essence its <strong>shows how top <span class="contributor">contributors</span> to <span class="central-repo repo-name">mozilla/pdf.js</span> are connected to the (other) <span class="repository">repositories</span> that they have made commits to.</strong></p>

                <div>
                    <p><strong>COLOR</strong> | The <span class="central-repo">central repository</span> that the visual is based on is shown in purple in the center. The <span class="contributor">contributors</span> to this repository are pink. Even the smaller pink circles around the outside are contributors to the central repository (just not those with the most commits, or supported through ORCA). Apart from that central repository, all other <span class="repository">repositories</span> are turquoise. When there are at least two repositories from the same owner, a circle for that <span class="owner">owner</span> is shown in yellow. </p>

                    <p><strong>CIRCLE SIZE</strong> | The size of the <span class="contributor">contributor</span> circles is based on the number of commits they made to the central <span class="repo-name">mozilla/pdf.js</span> repository. The size of the <span class="repository">repositories</span> circles is based on the number of stars it has received on GitHub. For <span class="owner">owner</span> circles it is the combined number of stars from all the <span class="repository">repositories</span> that are linked to it in this visual. There is one exception, the size of the central "main" repository <span class="repo-name"></span> is always enlarged to a fixed size and not determined by the number of stars.</p>
                    
                    <p><strong>INNER & OUTER PURPLE RINGS</strong> | The top <span class="contributor">contributors</span> are placed in a circle around the <span class="central-repo">central repository</span>. They are ordered by their first commit time to that repository, starting from "Noon" and going clockwise. Furthermore, they are divided into two rings. Contributors that are placed in the inner (slightly darker) purple ring have received ORCA for their contributions to <span id="title-repo-name" class="central-repo">mozilla/pdf.js</span>. Whereas the outer ring shows other top contributors (based on the number of commits), but that have not received ORCA.</p>

                    <p><strong>FULLY OPAQUE vs TRANSPARENT <span class="repository">REPOSITORIES</span></strong> | If you look closer you might notice that some <span class="repository">repository</span> circles are partly transparent and have a smaller central opaque dot in the center. These are repositories that are not "impacted" by any <span class="contributor">contributor</span> in this visualization that has received ORCA. The fully opaque <span class="repository">repository</span> circles, on the other hand, have at least one <span class="contributor">contributor</span> that has received ORCA for their work on <span class="repo-name-only">pdf.js</span> (hover over the repository to see how many ORCA recipients are connected to it).</p>
                </div>
                <div>
                    <p><strong>LINES</strong> | The lines connect <span class="contributor">contributors</span> to the <span class="repository">repositories</span> that they have made commits to (only showing repositories with at least 30 stars). When multiple <span class="repository">repositories</span> from the same <span class="owner">owner</span> are present in the visual, a circle for that owner is shown to which their repositories are connected.</p>

                    <p><strong>LINE THICKNESS</strong> | The thickness of each line is determined by the number of commits made from the <span class="contributor">contributor</span> on one end to the <span class="repository">repository</span> on the other end (or the combined repositories for an <span class="owner">owner</span> circle).</p>

                    <p><strong>ARCS around CIRCLES</strong> | You can see small purple arcs around the <span class="contributor">contributors</span>. This shows for how much time during the existence of <span id="title-repo-name" class="central-repo">mozilla/pdf.js</span> that contributor has been active in its development. You can see a full circle as the total time between the creation of <span class="repo-name-only">pdf.js</span> and its most recent commit. "Noon" is the point where the arc starts (and ends again). The arc around a contributor shows during what span of that time this person made their first and most recent commit to <span class="repo-name-only">pdf.js</span>.</p>
                    <p>When you hover over a <span class="contributor">contributor</span> you might see small pink arcs around the <span class="repository">repositories</span> that are connected to them. The idea is the same as the purple arcs, but now you can see for how much time that contributor has been active for each of the repositories that they are connected to. Often it can be only one or two commits, which won't visibly show an arc because the time scale is too short. If you want to investigate any of the repositories that a certain contributor is connected to, click on the contributor to fix all of their connected repositories in place and hover over each to reveal even more information.</p>

                    <p><strong>INTERACTION</strong> | <strong>Hover over any circle</strong> to see all of its connections; From a <span class="contributor">contributor</span> to all the repositories that they've worked on or from one <span class="repository">repository</span> to all of the (top) contributors that have worked on it. <strong>Click on a circle</strong> to fix the visual with all the circle's links highlighted to better investigate its network of direct connections.</p>
                </div>
            </div>

            <div id="orca-explanation" class="double-column">
                <p class="header"><strong>WHAT IS ORCA</strong></p>
                <p>Explain ORCA...</p>
            </div>

            <div id="chart-notes" class="double-column">
                <p class="header"><strong>DATA NOTES</strong></p>
                <p><strong>NOTE 1</strong> | Only repositories that have at least 30 stars have been taken into account. Contributors could have made more commits to repositories with fewer stars. Those repositories are not visualized here.</p>
                <p><strong>NOTE 2</strong> | During the data preparation and analysis phase we tried to group the top contributors to a <i>unique</i> person by grouping all commits coming from the same email address and/or coming from the exact same name.</p>
            </div>

            <div id="chart-extra">
                <button id="dataviz-download-data">Download the RAW data</button>
                <p id="dataviz-credit">Visualization Designed & Created by Nadieh Bremer | <a href="https://www.visualcinnamon.com/" target="_blank">Visual Cinnamon</a></p>
            </div>
        </div>

        <script>
            let params = new URLSearchParams(window.location.search)
            const REPOSITORY = [
                "pdfjs",
                "terraform"
            ].indexOf(params.get("repo")) === -1 ? "pdfjs" : params.get("repo")

            let REPOSITORY_FULL = "mozilla/pdf.js" // Default
            if (REPOSITORY === "terraform") REPOSITORY_FULL = "hashicorp/terraform"

            let REPOSITORY_NAME = REPOSITORY_FULL.substring(REPOSITORY_FULL.indexOf("/") + 1)

            // Replace the "title-repo-name" with the repository name
            document.getElementById("title-repo-name").innerHTML = REPOSITORY_FULL
            // Replace all the classed "repo-name" with the repository name
            document.querySelectorAll(".repo-name").forEach(d => d.innerHTML = REPOSITORY_FULL)
            document.querySelectorAll(".repo-name-only").forEach(d => d.innerHTML = REPOSITORY_NAME)

            /////////////////////////////////////////////////////////
            ///////////////////////// START /////////////////////////
            /////////////////////////////////////////////////////////

            ////////////////// Datasets to Read in //////////////////
            let promises = []
            promises.push(d3.csv(`data/${REPOSITORY}/top_contributors.csv`))
            promises.push(d3.csv(`data/${REPOSITORY}/repositories.csv`))
            promises.push(d3.csv(`data/${REPOSITORY}/links.csv`))
            promises.push(d3.csv(`data/${REPOSITORY}/remaining_contributors.csv`))

            /////////////////// Fonts to activate ///////////////////
            const FONT_FAMILY = "Atkinson Hyperlegible"
            document.fonts.load(`normal 400 10px "${FONT_FAMILY}"`)
            document.fonts.load(`italic 400 10px "${FONT_FAMILY}"`)
            document.fonts.load(`normal 700 10px "${FONT_FAMILY}"`)
            document.fonts.load(`italic 700 10px "${FONT_FAMILY}"`)

            /////////////////// Figure out sizing ///////////////////
            // Get the div container that will hold the chart
            let container = document.getElementById("chart-wrapper")
            // Get the width of the container
            let width = container.offsetWidth
            // You can set the height to anything you want, but the same as the width is the default
            let height = width

            ///////////////////// Start Drawing /////////////////////
            // Set-up the visual - Doesn't draw anything yet
            // NOTE: This visual still uses a random "ORCA_LEVEL" variable for now
            let ORCAVisual = createORCAVisual()
                .width(width)
                .height(height)
                .repository(REPOSITORY_FULL)

            // Read in the data and create the visual
            document.fonts.ready.then(() => {
                Promise.all(promises).then(values => {
                    let formatDigit = d3.format(",.2r")
                    let formatPercentage = d3.format(".0%")

                    // Create a deep copy of the data in values
                    let data_raw = []
                    data_raw.push(JSON.parse(JSON.stringify(values[0]))) // top contributors
                    data_raw.push(JSON.parse(JSON.stringify(values[1]))) // repositories
                    data_raw.push(JSON.parse(JSON.stringify(values[2]))) // links
                    data_raw.push(JSON.parse(JSON.stringify(values[3]))) // remaining contributors

                    /////////////////////////////////////////////////
                    // Very specific to this example, but get some statistics on the data and put this in the intro text
                    let num_contributors = values[0].length + values[3].length
                    document.getElementById("repo-num-contributors").innerHTML = `~${formatDigit(num_contributors)} `
                    
                    // How many contributors are there in the inner two rings
                    document.querySelectorAll(".top-contributor-num").forEach(d => d.innerHTML = `${formatDigit(values[0].length)} `)

                    // How many repositories are in the visual
                    document.getElementById("top-repo-num").innerHTML = `, at least, ${formatDigit(values[1].length)} other`

                    /////////////////////////////////////////////////
                    // It expects the four datasets of contributors (authors), repositories, links between contributors and repositories, and remaining contributors, in that order
                    ORCAVisual(values)

                    /////////////////////////////////////////////////
                    // Get the start date of the central repository
                    // Find the REPOSITORY_FULL in the links dataset
                    let central_repo = values[1].find(d => d.repo === REPOSITORY_FULL)
                    let formatDate = d3.timeFormat("%B %Y")
                    // let start_date = new Date(values[1][0].created_at)
                    document.getElementById("repo-start-date").innerHTML = ` in ${formatDate(central_repo.createdAt)}`

                    /////////////////////////////////////////////////
                    // Update the bar chart in the intro
                    let bar_chart = document.getElementById("commit-bar-chart")
                    // Get the sum of commits made by the remaining contributors
                    let sum_remaining = d3.sum(values[3], d => d.commit_count)
                    // Get the sum of commits made by the non-ORCA contributors
                    let sum_non_orca = d3.sum(values[0].filter(c => c.orca_received === false), d => d.link_central.commit_count)
                    // Get the sum of commits made by the ORCA contributors
                    let sum_orca = d3.sum(values[0].filter(c => c.orca_received === true), d => d.link_central.commit_count)

                    // Update the bar chart slice width
                    bar_chart.style.gridTemplateColumns = `${sum_orca}fr ${sum_non_orca}fr ${sum_remaining}fr`

                    // Number of commits by top contributors
                    document.getElementById("num-commits-top").innerHTML = `${formatDigit(sum_non_orca + sum_orca)} `

                    // Percentage of commits by top contributors
                    document.getElementById("percentage-commits-top").innerHTML = `${formatPercentage((sum_non_orca + sum_orca) / (sum_remaining + sum_non_orca + sum_orca))} `

                    // Number of people
                    let num_orca = values[0].filter(c => c.orca_received === true).length
                    let num_non_orca = values[0].filter(c => c.orca_received === false).length
                    document.getElementById("num-orca").innerHTML = `${num_orca < 10 ? num_orca : formatDigit(num_orca)} | `
                    document.getElementById("num-non-orca").innerHTML = `${num_non_orca < 10 ? num_non_orca : formatDigit(num_non_orca)} | `
                    document.getElementById("num-remaining").innerHTML = `${formatDigit(values[3].length)} | `

                    // Reveal the bar chart
                    document.getElementById("bar-chart-wrapper").style.opacity = `1`

                    /////////////////////////////////////////////////
                    // Let people download the raw data
                    const download_button = document.getElementById("dataviz-download-data")
                    download_button.addEventListener("click", () => {

                        // Download all four datasets
                        downloadData(data_raw[0], `${REPOSITORY}-top_contributors`)
                        downloadData(data_raw[1], `${REPOSITORY}-repositories`)
                        downloadData(data_raw[2], `${REPOSITORY}-links`)
                        downloadData(data_raw[3], `${REPOSITORY}-remaining_contributors`)

                        function downloadData(data, filename) {
                            // Create a blob of the data
                            let blob = new Blob([d3.csvFormat(data)], {type: "text/csv;charset=utf-8"})
                            // Create a link to download it
                            let link = document.createElement("a")
                            link.href = window.URL.createObjectURL(blob)
                            link.download = `${filename}.csv`
                            // Click the link
                            link.click()
                        }// function downloadData
                    })//on click
                })//promises
            })//fonts.ready

            /////////////////////////////////////////////////////////
            ////////////////// Handle page resizing /////////////////
            /////////////////////////////////////////////////////////

            let current_width = window.innerWidth
            let resizeTimer = null
            window.addEventListener("resize", function () {
                // Reset timer - Only resize if something truly appears to happen
                // So added a little timeout
                clearTimeout(resizeTimer)

                resizeTimer = setTimeout(() => {
                    // Only resize if the width is changed
                    if (window.innerWidth !== current_width) {
                        current_width = window.innerWidth

                        // Get the new sizes
                        let width = container.offsetWidth
                        let height = width

                        //Update the visual
                        ORCAVisual
                            .width(width)
                            .height(height)
                            .resize()
                    }// if
                }, 300)
            })//on resize

        </script>
	</body>
</html>