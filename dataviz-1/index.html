<!DOCTYPE html>
	<head>
        <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, shrink-to-fit=0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	    <title>ORCA</title>
	    <meta name="author" content="Nadieh Bremer">
	    <meta name="description" content="">
        <link rel="shortcut icon" href="#">

        <style>
            html {
                --color-repo-main: #a682e8;
                --color-repo: #64d6d3;
                --color-owner: #f2a900;
                --color-contributor: #ea9df5;
                --color-text: #4d4950;
                --color-background: #f7f7f7;
                --color-gradient: linear-gradient(to right, var(--color-contributor), var(--color-repo-main), var(--color-repo)) 1;
            }

            body {
                margin: 0;
                font-family: 'Atkinson Hyperlegible', sans-serif;
            }

            .central-repo {
                /* color: var(--color-repo-main); */
                background: var(--color-repo-main);
                padding: 0.1em 0.3em;
                font-weight: 700;
                color: white
            }

            .contributor {
                /* color: var(--color-contributor); */
                background: var(--color-contributor);
                padding: 0.1em 0.3em;
                font-weight: 700;
            }

            .repository {
                background: var(--color-repo);
                padding: 0.1em 0.3em;
                /* border-bottom: 0.3em solid var(--color-repo); */
                font-weight: 700;
            }

            .repo-name-only {
                font-style: italic;
            }

            .owner {
                /* color: var(--color-owner); */
                background: var(--color-owner);
                padding: 0.1em 0.3em;
                font-weight: 700;
            }

            p {
                line-height: 140%;
                color: var(--color-text);
            }


            #chart-wrapper {
                min-width: 900px; /* Min size that the visual can becom */
                max-width: 1400px; /* Max size that the visual can become */

                border-top: 10px solid var(--color-repo-main);
                border-image: var(--color-gradient);
                margin: 0 auto;
            }

            #chart-textual {
                /* Create a linear gradient for the background going from transparent #f7f7f7 to #f7f7f7 downward */
                background: linear-gradient(to bottom, rgba(247, 247, 247, 0) 50%, rgba(247, 247, 247, 1) 100%);
                padding: 3em 5em 2em 5em;

                display: grid;
                justify-content: center;
                align-items: top;

                grid-template-columns: 1fr 2fr;
                column-gap: 5em;
                row-gap: 5em;
            }

            #chart-explanation {
                background: linear-gradient(to bottom, rgba(247, 247, 247, 1) 50%, rgba(247, 247, 247, 0) 100%);
                min-height: 200px;
                padding: 3em 5em 2em 5em;

                font-size: 1.2em;

                display: grid;
                justify-content: center;
                align-items: top;

                grid-template-columns: 1fr 1fr;
                column-gap: 7em;
                row-gap: 1em;
            }

            #chart-explanation p {
                line-height: 160%;
                font-size: 0.8em;
                /* color:#6e6a71; */
                /* opacity: 0.6; */
                /* font-style: italic; */
            }

            #chart-explanation .title {
                grid-column-start: 1;
                grid-column-end: 3;
                grid-row-start: 1;
                grid-row-end: 1;
                font-size: 1.0em;
            }


            #orca-explanation {
                padding: 3em 5em 2em 5em;

                font-size: 1.2em;

                display: grid;
                justify-content: center;
                align-items: top;

                grid-template-columns: 1fr;
                column-gap: 7em;
                row-gap: 1em;
            }

            .title {
                text-align: center;
                font-size: 1.0em;
                padding-bottom: 0.5em;
                margin-bottom: 0;

                border-bottom: 3px solid var(--color-repo-main);
                border-image: var(--color-gradient);
            }


            #chart-title {
                grid-column-start: 1;
                grid-column-end: 1;
            }
            #chart-title h1 {
                font-weight: 400;
                font-size: 2.4em;
                font-style: italic;
                margin-bottom: 0.2em; 
                margin-top: 0em;
            }
            #chart-title h1#title-repo-name {
                font-weight: 700;
                font-size: 2.6em;
                margin-top: 0.2em;
                font-style: normal;
            }

            #chart-intro-text {
                grid-column-start: 2;
                grid-column-end: 2;
                font-weight: 400;
                font-size: 1.1em;
            }

            #explanation-note {
                border-bottom: 2px solid var(--color-repo-main);
                border-image:linear-gradient(to right, var(--color-owner), var(--color-contributor), var(--color-repo)) 1;
                /* border-image: var(--color-gradient); */
                font-size: 0.9em;
                font-style: italic;
                color: var(--color-text);
                text-decoration: none;
            }

            #chart-extra {
                position: relative;
                text-align: center;
            }

            #dataviz-download-data {
                text-align: center;
                background: var(--color-repo-main);
                color: white;
                border: none;
                padding: 0.5em 1em;
                font-size: 1.0em;
                font-weight: 700;
                cursor: pointer;
                margin: 1em auto;
            }

            #dataviz-credit {
                font-style: italic;
                text-align: center;
                margin-top: 2em;
                margin-bottom: 2em;
                opacity: 0.8;
                font-size: 0.9em;
            }

            #dataviz-credit a {
                border-bottom: 3px solid var(--color-repo-main);
                border-image:linear-gradient(to right, var(--color-contributor), var(--color-repo)) 1;
                /* padding: 0.1em 0.3em; */
                font-weight: 700;
                cursor: pointer;
                color: var(--color-text);
                text-decoration: none;
            }



            /* CHART */
            #chart-container {
                position: relative;
                background-color: var(--color-background); /* Same as the COLOR_BACKGROUND in the visual */
            }

            #chart-container canvas {
                display: block;
                margin: 0;
            }

            #canvas, #canvas-click {
                position: absolute;
                top: 0;
                pointer-events: none;
                z-index: 0;
                transition: opacity 200ms ease-in;
            }

            #canvas-hover {
                position: relative;
                z-index: 1
            }
        </style>
		
        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

        <!-- JavaScript files -->
        <script src="lib/d3.v7.js"></script>
        <script src="lib/d3-delaunay.js"></script>
        <script src="lib/d3-bboxCollide.min.js"></script>
        <!-- <script src="lib/spectral.js"></script> -->

        <!-- Custom JavaScript file -->
        <script src="createORCAVisual.js"></script>

	</head>
	<body>
        <div id="chart-wrapper">
            <div id="chart-textual">
                <div id="chart-title">
                    <h1>The Top Contributor Network of</h1>
                    <h1><span id="title-repo-name" class="central-repo">mozilla/pdf.js</span></h1>
                </div>
                <div id="chart-intro-text">
                    <p>The <span class="repo-name central-repo">mozilla/pdf.js</span> repository has seen many improvements from its <span id="repo-num-contributors"></span><span class="contributor">contributors</span> since it was created<span id="repo-start-date"></span>.</p>

                    <p><strong>The visual below shows all of the contributors to <span class="repo-name-only">pdf.js</span> and focuses on the <span id="top-contributor-num"></span>contributors that have made the most commits.</strong> Revealing how they are involved with<span id="top-repo-num"> other</span> <span class="repository">repositories</span> as well. <span style="font-size: 0.7em; opacity: 0.6; font-style: italic;">(only counting repos with at least 30 stars)</span></p>

                    <p>The top contributors are separated into two outer rings. In the inner ring we find those that have been supported via ORCA (the <strong>"Open Retrospective Compensation Agreement"</strong>) for their work on <span class="repo-name-only">pdf.js</span>. Whereas in the outer ring we find those that have not (yet).</p>

                    <p>In the <strong>center we focus on the connections <i>amongst</i> contributors</strong>. Where we can find those repositories that multiple contributors have worked on (and the <span class="owner">owners</span>, if there is more than one of their repos present).</p>

                    <p>Explore the ecosystem of open source projects that are touched by the top contributors to <span class="repo-name-only">pdf.js</span>. See how the impact of ORCA <i>could</i> reach far wider than just that one repository.</p>

                    <p><a id="explanation-note" href="#chart-explanation"><strong>For a full explanation on how to read this visual, see the bottom of this page.</strong></a></p>
                </div>
            </div>

            <div id="chart-container">
                <canvas id="canvas"></canvas>
                <canvas id="canvas-click"></canvas>
                <canvas id="canvas-hover"></canvas>
            </div>

            <div id="chart-explanation">
                <p class="title"><strong>HOW TO READ THIS VISUAL</strong></p>

                <div>
                    <p><strong>COLOR</strong> | The <span class="central-repo">central repository</span> that the visual is based on is shown in purple in the center. The <span class="contributor">contributors</span> to this repository are pink. Even the smaller pink circles around the outside are contributors to the central repository (just not those with the most commits). Apart from that central repository, all other <span class="repository">repositories</span> are turquoise. When there are at least two repositories from the same owner, a circle for that <span class="owner">owner</span> is shown in yellow. </p>

                    <p><strong>CIRCLE SIZE</strong> | The size of the <span class="contributor">contributor</span> circles is based on the number of commits they made to the central <span class="repo-name">mozilla/pdf.js</span> repository. The size of the <span class="repository">repositories</span> circles is based on the number of stars it has received on GitHub. For <span class="owner">owner</span> circles it is the combined number of stars from all the <span class="repository">repositories</span> that are linked to it in this visual. There is one exception, the size of the central "main" repository <span class="repo-name"></span> is always enlarged to a fixed size and not determined by the number of stars.</p>
                    
                    <p><strong>LINE THICKNESS</strong> | The thickness of each line is determined by the number of commits made from the <span class="contributor">contributor</span> on one end to the <span class="repository">repository</span> on the other end (or the combined repositories for an <span class="owner">owner</span> circle).</p>

                    <p><strong>ARCS around CIRCLES</strong> | ...</p>
                    <p><strong>INNER & OUTER PURPLE RINGS</strong> | ...</p>
                    <p><strong>Filled Repo Circles vs those with central Dot</strong> | ...</p>
                </div>
                <div>                    
                    <p><strong>INTERACTION</strong> | <strong>Hover over any circle</strong> to see all of its connections; From a <span class="contributor">contributor</span> to all the repositories that they've worked on or from one <span class="repository">repository</span> to all of the (top) contributors that have worked on it. <strong>Click on a circle</strong> to fix the visual with all the circle's links highlighted to better investigate its network of direct connections.</p>

                    <p><strong>NOTE 1</strong> | Only repositories that have at least 30 stars have been taken into account to visualize. Contributors could have made more commits to repositories with fewer stars. These repositories are not visualized here.</p>
                    <p><strong>NOTE 2</strong> | How we tried to group the top contributors by their shared emails and names...</p>
                </div>
            </div>

            <div id="orca-explanation">
                <p class="title"><strong>WHAT IS ORCA</strong></p>
                <p>Explain ORCA...</p>
            </div>

            <div id="chart-extra">
                <button id="dataviz-download-data">Download the RAW data</button>
                <p id="dataviz-credit">Visualization Designed & Created by Nadieh Bremer | <a href="https://www.visualcinnamon.com/" target="_blank">Visual Cinnamon</a></p>
            </div>
        </div>

        <script>
            let params = new URLSearchParams(window.location.search)
            const REPOSITORY = [
                "pdfjs",
                "terraform"
            ].indexOf(params.get("repo")) === -1 ? "pdfjs" : params.get("repo")

            let REPOSITORY_FULL = "mozilla/pdf.js" // Default
            if (REPOSITORY === "terraform") REPOSITORY_FULL = "hashicorp/terraform"

            let REPOSITORY_NAME = REPOSITORY_FULL.substring(REPOSITORY_FULL.indexOf("/") + 1)

            // Replace the "title-repo-name" with the repository name
            document.getElementById("title-repo-name").innerHTML = REPOSITORY_FULL
            // Replace all the classed "repo-name" with the repository name
            document.querySelectorAll(".repo-name").forEach(d => d.innerHTML = REPOSITORY_FULL)
            document.querySelectorAll(".repo-name-only").forEach(d => d.innerHTML = REPOSITORY_NAME)

            /////////////////////////////////////////////////////////
            ///////////////////////// START /////////////////////////
            /////////////////////////////////////////////////////////

            ////////////////// Datasets to Read in //////////////////
            let promises = []
            promises.push(d3.csv(`data/${REPOSITORY}/top_contributors.csv`))
            promises.push(d3.csv(`data/${REPOSITORY}/repositories.csv`))
            promises.push(d3.csv(`data/${REPOSITORY}/links.csv`))
            promises.push(d3.csv(`data/${REPOSITORY}/remaining_contributors.csv`))

            /////////////////// Fonts to activate ///////////////////
            const FONT_FAMILY = "Atkinson Hyperlegible"
            document.fonts.load(`normal 400 10px "${FONT_FAMILY}"`)
            document.fonts.load(`italic 400 10px "${FONT_FAMILY}"`)
            document.fonts.load(`normal 700 10px "${FONT_FAMILY}"`)
            document.fonts.load(`italic 700 10px "${FONT_FAMILY}"`)

            /////////////////// Figure out sizing ///////////////////
            // Get the div container that will hold the chart
            let container = document.getElementById("chart-wrapper")
            // Get the width of the container
            let width = container.offsetWidth
            // You can set the height to anything you want, but the same as the width is the default
            let height = width

            ///////////////////// Start Drawing /////////////////////
            // Set-up the visual - Doesn't draw anything yet
            // NOTE: This visual still uses a random "ORCA_LEVEL" variable for now
            let ORCAVisual = createORCAVisual()
                .width(width)
                .height(height)
                .repository(REPOSITORY_FULL)

            // Read in the data and create the visual
            document.fonts.ready.then(() => {
                Promise.all(promises).then(values => {
                    let formatDigit = d3.format(",.2r")

                    // Create a deep copy of the data in values
                    let data_raw = []
                    data_raw.push(JSON.parse(JSON.stringify(values[0]))) // top contributors
                    data_raw.push(JSON.parse(JSON.stringify(values[1]))) // repositories
                    data_raw.push(JSON.parse(JSON.stringify(values[2]))) // links
                    data_raw.push(JSON.parse(JSON.stringify(values[3]))) // remaining contributors

                    // Very specific to this example, but get some statistics on the data and put this in the intro text
                    let num_contributors = values[0].length + values[3].length
                    document.getElementById("repo-num-contributors").innerHTML = `~${formatDigit(num_contributors)} `
                    
                    // How many contributors are there in the inner two rings
                    document.getElementById("top-contributor-num").innerHTML = `${formatDigit(values[0].length)} `

                    // How many repositories are in the visual
                    document.getElementById("top-repo-num").innerHTML = `, at least, ${formatDigit(values[1].length)} other`

                    // It expects the four datasets of contributors (authors), repositories, links between contributors and repositories, and remaining contributors, in that order
                    ORCAVisual(values)

                    // Get the start date of the central repository
                    // Find the REPOSITORY_FULL in the links dataset
                    let central_repo = values[1].find(d => d.repo === REPOSITORY_FULL)
                    let formatDate = d3.timeFormat("%B %Y")
                    // let start_date = new Date(values[1][0].created_at)
                    document.getElementById("repo-start-date").innerHTML = ` in ${formatDate(central_repo.createdAt)}`

                    /////////////////////////////////////////////////////////
                    // Let people download the raw data
                    const download_button = document.getElementById("dataviz-download-data")
                    download_button.addEventListener("click", () => {

                        // Download all four datasets
                        downloadData(data_raw[0], `${REPOSITORY}-top_contributors`)
                        downloadData(data_raw[1], `${REPOSITORY}-repositories`)
                        downloadData(data_raw[2], `${REPOSITORY}-links`)
                        downloadData(data_raw[3], `${REPOSITORY}-remaining_contributors`)

                        function downloadData(data, filename) {
                            // Create a blob of the data
                            let blob = new Blob([d3.csvFormat(data)], {type: "text/csv;charset=utf-8"})
                            // Create a link to download it
                            let link = document.createElement("a")
                            link.href = window.URL.createObjectURL(blob)
                            link.download = `${filename}.csv`
                            // Click the link
                            link.click()
                        }// function downloadData
                    })//on click
                })//promises
            })//fonts.ready

            /////////////////////////////////////////////////////////
            ////////////////// Handle page resizing /////////////////
            /////////////////////////////////////////////////////////

            let current_width = window.innerWidth
            let resizeTimer = null
            window.addEventListener("resize", function () {
                // Reset timer - Only resize if something truly appears to happen
                // So added a little timeout
                clearTimeout(resizeTimer)

                resizeTimer = setTimeout(() => {
                    // Only resize if the width is changed
                    if (window.innerWidth !== current_width) {
                        current_width = window.innerWidth

                        // Get the new sizes
                        let width = container.offsetWidth
                        let height = width

                        //Update the visual
                        ORCAVisual
                            .width(width)
                            .height(height)
                            .resize()
                    }// if
                }, 300)
            })//on resize

        </script>
	</body>
</html>